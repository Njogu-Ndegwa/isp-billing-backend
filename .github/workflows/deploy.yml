name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: njogundegwa/isp-billing

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build --no-cache -t ${{ env.IMAGE_NAME }}:latest .
          docker push ${{ env.IMAGE_NAME }}:latest

      - name: Deploy to AWS EC2
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          echo "=========================================="
          echo "Starting deployment at $(date)"
          echo "=========================================="
          
          echo "[1/6] Navigating to project directory..."
          cd ~/apps/isp-billing || { echo "ERROR: Directory not found"; exit 1; }
          echo "Current directory: $(pwd)"
          
          echo "[2/6] Pulling latest code from GitHub..."
          git config --global --add safe.directory ~/apps/isp-billing
          git pull origin main || { echo "ERROR: Git pull failed"; exit 1; }
          echo "Git pull successful"
          
          echo "[3/6] Checking disk space..."
          df -h / | tail -1
          
          echo "[4/6] Pulling latest Docker image from Docker Hub..."
          docker pull njogundegwa/isp-billing:latest || { echo "ERROR: Docker pull failed"; exit 1; }
          echo "Image pulled successfully"
          echo "Image digest:"
          docker inspect njogundegwa/isp-billing:latest --format='{{.Id}}'
          
          echo "[5/6] Restarting containers with Docker Hub image..."
          docker compose down
          docker rmi isp-billing-web 2>/dev/null || true
          docker tag njogundegwa/isp-billing:latest isp-billing-web:latest
          docker compose up -d --no-build --force-recreate || { echo "ERROR: Docker compose failed"; exit 1; }
          
          echo "Verifying deployed image matches Docker Hub:"
          docker inspect isp_billing_app --format='{{.Image}}'
          
          echo "[6/6] Cleaning up old images..."
          docker image prune -f
          
          echo "=========================================="
          echo "Deployment complete at $(date)"
          echo "=========================================="
          
          echo "Container status:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "isp|NAMES"
          
          echo "Recent app logs:"
          docker logs isp_billing_app --tail 10 2>&1 || true
          ENDSSH
